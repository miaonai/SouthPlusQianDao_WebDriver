name: 签到

on:
  schedule:
    - cron: '00 16 * * *'
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.x

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Install Chrome
      run: |
        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get install -f
        sudo apt-get install -y google-chrome-stable
    
    - name: Setup ChromeDriver
      uses: nanasess/setup-chromedriver@v2

    # --- 新增步骤 1：安装 Shadowsocks 客户端 ---
    - name: Install Shadowsocks Client
      run: sudo apt-get update && sudo apt-get install -y shadowsocks-libev

    # --- 新增步骤 2：在后台启动代理 ---
    - name: Start Proxy Client
      env:
        PROXY_SERVER: ${{ secrets.PROXY_SERVER }}
        PROXY_PORT: ${{ secrets.PROXY_PORT }}
        PROXY_PASSWORD: ${{ secrets.PROXY_PASSWORD }} # 你的配置中缺少密码，但 ss 协议一定需要
        PROXY_CIPHER: ${{ secrets.PROXY_CIPHER }}
      run: |
        nohup ss-local \
          -s "$PROXY_SERVER" \
          -p "$PROXY_PORT" \
          -k "$PROXY_PASSWORD" \
          -m "$PROXY_CIPHER" \
          -b "0.0.0.0" \
          -l "1080" > ss-local.log 2>&1 &
        sleep 2 # 等待代理客户端启动

    - name: 总脚本
      id: run_script
      env:
        COOKIE: ${{ secrets.COOKIE }}
      run: python byWebdrvier.py

    - name: Upload screenshot on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-screenshot
        path: error_screenshot.png
